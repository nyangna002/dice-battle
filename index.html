<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Dice Battle - Noir Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { background:#121212; color:#eee; font-family:"Noto Serif KR", serif; padding:20px; display:flex; flex-direction:column; align-items:center; }
        .container { max-width: 400px; width: 100%; }
        input, button { padding:10px; margin:5px 0; font-size:14px; width: 100%; box-sizing: border-box; background:#1e1e1e; color:#fff; border:1px solid #333; cursor:pointer; }
        button:hover { background:#222; border-color:#555; }
        button:disabled { opacity:.3; cursor:not-allowed; }
        .hp-bar { height:18px; background:#333; margin: 5px 0 15px 0; border-radius:3px; overflow:hidden; }
        .hp-fill { height:100%; transition: width 0.5s ease-in-out; width: 100%; }
        .status-text { font-size:13px; color:#888; margin-bottom: 2px; }
        #logs { 
            background: #0a0a0a; border: 1px solid #222; padding: 10px; height: 150px; 
            overflow-y: auto; font-size: 12px; list-style: none; margin-top: 20px;
        }
        #logs li { border-bottom: 1px solid #1a1a1a; padding: 4px 0; color: #bbb; }
        .noir-card {
            display:none; background:#0f0f0f; border:2px solid #333; padding:18px;
            color:#e0e0e0; box-shadow:0 0 25px rgba(0,0,0,0.9); margin-top:20px;
        }
        .noir-title { font-size:12px; letter-spacing:2px; color:#555; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:10px; }
        .noir-footer { display:flex; justify-content:space-between; font-size:10px; color:#444; border-top:1px solid #333; padding-top:8px; margin-top:10px; }
        hr { width: 100%; border: 0; border-top: 1px solid #333; margin: 20px 0; }
    </style>
</head>
<body>

<div class="container">
    <h2>DICE BATTLE</h2>
    
    <div id="setupUI">
        <input id="roomInput" placeholder="ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"/>
        <button id="createRoom">ìƒˆë¡œìš´ ì „ì¥ ë§Œë“¤ê¸°</button>
        <button id="enterRoom">ê¸°ì¡´ ì „ì¥ ì…ì¥í•˜ê¸°</button>
    </div>

    <div id="gameUI" style="display:none;">
        <p style="text-align:center; color:#888;">ì ‘ì†: <b id="meDisplay"></b> (<span id="mySideDisplay"></span>)</p>
        <h3 id="turnDisplay" style="text-align:center; color:#f1c40f;">ìƒëŒ€ ëŒ€ê¸° ì¤‘...</h3>

        <div>
            <div class="status-text"><span id="nameA">í”Œë ˆì´ì–´ A</span> <span id="bleedingA"></span></div>
            <div class="hp-bar"><div id="hpA" class="hp-fill"></div></div>
        </div>

        <div>
            <div class="status-text"><span id="nameB">í”Œë ˆì´ì–´ B</span> <span id="bleedingB"></span></div>
            <div class="hp-bar"><div id="hpB" class="hp-fill"></div></div>
        </div>

        <button id="attackBtn" disabled>ğŸ² ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° (ê³µê²©)</button>
        <button id="restartBtn" style="display:none; background:#2c3e50;">ë‹¤ì‹œ ì‹œì‘</button>
        <button id="copyBtn" style="display:none; background:#27ae60;">ğŸ“‹ ì „íˆ¬ ê²°ê³¼ ìš”ì•½ ë³µì‚¬</button>

        <ul id="logs"></ul>

        <div id="noirCard" class="noir-card">
            <div class="noir-title">BATTLE REPORT</div>
            <p id="noirSummary" style="font-size:14px; margin:0;"></p>
            <p id="noirInjury" style="font-size:13px; color:#888; margin-top:5px;"></p>
            <div class="noir-footer">
                <span id="noirWinner"></span>
                <span id="noirDate"></span>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

    // Firebase ì„¤ì • (ë³¸ì¸ì˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”)
const firebaseConfig = {
  apiKey: "AIzaSyB5DBFCeHAy0ZhM3ITwu4MklaGqtqv9vhU",
  authDomain: "dice-7fe9a.firebaseapp.com",
  databaseURL: "https://dice-7fe9a-default-rtdb.firebaseio.com",
  projectId: "dice-7fe9a"
};
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let roomId = "";
    let mySide = ""; 
    let myName = "";
    const BODY_PARTS = ["ë¨¸ë¦¬", "ì‹¬ì¥", "ì–´ê¹¨", "ë³µë¶€", "í—ˆë²…ì§€", "ì†ëª©"];

    const setupUI = document.getElementById("setupUI");
    const gameUI = document.getElementById("gameUI");
    const logsEl = document.getElementById("logs");

    document.getElementById("createRoom").onclick = async () => {
        const id = document.getElementById("roomInput").value.trim();
        if(!id) return alert("ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        myName = prompt("ë‹¹ì‹ ì˜ ì´ë¦„ì€?") || "ë¬´ëª…ê°";
        roomId = id;
        mySide = "A";
        await set(ref(db, `rooms/${roomId}`), {
            players: { A: { name: myName, hp: 50, bleeding: false }, B: { name: "ëŒ€ê¸° ì¤‘...", hp: 50, bleeding: false } },
            turn: "A", status: "waiting", logs: ["ì „ì¥ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."]
        });
        startGamelistener();
    };

    document.getElementById("enterRoom").onclick = async () => {
        const id = document.getElementById("roomInput").value.trim();
        if(!id) return alert("ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        const roomRef = ref(db, `rooms/${id}`);
        const snap = await get(roomRef);
        if(!snap.exists()) return alert("ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        myName = prompt("ë‹¹ì‹ ì˜ ì´ë¦„ì€?") || "ë°©ë¬¸ì";
        roomId = id;
        mySide = "B";
        await update(ref(db, `rooms/${roomId}/players/B`), { name: myName });
        await update(roomRef, { status: "playing", logs: [...snap.val().logs, `${myName} ì…ì¥. ì „íˆ¬ ê°œì‹œ.`] });
        startGamelistener();
    };

    function startGamelistener() {
        setupUI.style.display = "none";
        gameUI.style.display = "block";
        document.getElementById("meDisplay").innerText = myName;
        document.getElementById("mySideDisplay").innerText = mySide === 'A' ? 'HOST' : 'GUEST';
        onValue(ref(db, `rooms/${roomId}`), (snapshot) => {
            const data = snapshot.val();
            if(data) render(data);
        });
    }

    function render(s) {
        document.getElementById("nameA").innerText = s.players.A.name;
        document.getElementById("nameB").innerText = s.players.B.name;
        
        const hpA = s.players.A.hp;
        const hpB = s.players.B.hp;
        document.getElementById("hpA").style.width = Math.max(0, (hpA / 50 * 100)) + "%";
        document.getElementById("hpB").style.width = Math.max(0, (hpB / 50 * 100)) + "%";
        document.getElementById("hpA").style.background = hpA > 15 ? "#2ecc71" : "#e74c3c";
        document.getElementById("hpB").style.background = hpB > 15 ? "#2ecc71" : "#e74c3c";
        
        document.getElementById("bleedingA").innerText = s.players.A.bleeding ? "ğŸ©¸" : "";
        document.getElementById("bleedingB").innerText = s.players.B.bleeding ? "ğŸ©¸" : "";

        if(s.status === "finished") {
            document.getElementById("turnDisplay").innerText = "ì „íˆ¬ ì¢…ë£Œ";
            document.getElementById("attackBtn").disabled = true;
            document.getElementById("restartBtn").style.display = "block";
            showWinnerCard(s); // ìŠ¹ë¦¬ì ì „ìš© ì¹´ë“œ ë¡œì§ í˜¸ì¶œ
        } else {
            document.getElementById("turnDisplay").innerText = s.turn === mySide ? "ğŸ”´ ë‹¹ì‹ ì˜ í„´!" : "âšª ìƒëŒ€ì˜ í„´...";
            document.getElementById("attackBtn").disabled = (s.status === "waiting" || s.turn !== mySide);
            document.getElementById("noirCard").style.display = "none";
            document.getElementById("copyBtn").style.display = "none";
        }

        logsEl.innerHTML = "";
        [...s.logs].reverse().forEach(log => {
            const li = document.createElement("li");
            li.innerText = log;
            logsEl.appendChild(li);
        });
    }

    document.getElementById("attackBtn").onclick = async () => {
        const roomRef = ref(db, `rooms/${roomId}`);
        const snap = await get(roomRef);
        const s = snap.val();
        const targetSide = mySide === "A" ? "B" : "A";
        let logs = s.logs || [];
        let updates = {};
        let myHp = s.players[mySide].hp;
        let targetHp = s.players[targetSide].hp;

        if(s.players[mySide].bleeding) {
            myHp -= 2;
            logs.push(`[ìƒíƒœ] ${myName}ì´(ê°€) ì¶œí˜ˆë¡œ ì²´ë ¥ 2ë¥¼ ìƒì—ˆìŠµë‹ˆë‹¤.`);
        }

        const dice = Math.floor(Math.random() * 20) + 1;
        targetHp -= dice;
        logs.push(`[ê³µê²©] ${myName}ì˜ ì£¼ì‚¬ìœ„: ${dice}! (${s.players[targetSide].name} HP: ${Math.max(0, targetHp)})`);

        if(dice >= 15 && Math.random() < 0.3) {
            updates[`players/${targetSide}/bleeding`] = true;
            logs.push(`[ì¹˜ëª…íƒ€] ${s.players[targetSide].name}ì—ê²Œ ì¶œí˜ˆ ë°œìƒ!`);
        }

        updates[`players/${mySide}/hp`] = myHp;
        updates[`players/${targetSide}/hp`] = targetHp;
        updates[`turn`] = targetSide;

        if(targetHp <= 0 || myHp <= 0) {
            const winnerSide = targetHp <= 0 ? mySide : targetSide;
            const loserSide = winnerSide === "A" ? "B" : "A";
            const injury = BODY_PARTS[Math.floor(Math.random() * BODY_PARTS.length)];
            updates[`status`] = "finished";
            updates[`winner`] = winnerSide;
            logs.push(`[ê²°ê³¼] ${s.players[winnerSide].name} ìŠ¹ë¦¬!`);
            logs.push(`[ë¶€ìƒ] ${s.players[loserSide].name}ì€(ëŠ”) ${injury} ë¶€ìœ„ê°€ íŒŒì†ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        updates[`logs`] = logs;
        await update(roomRef, updates);
    };

    function showWinnerCard(s) {
        // ë‚´ê°€ ìŠ¹ë¦¬í–ˆì„ ë•Œë§Œ ë³´ì—¬ì¤Œ
        if(s.winner === mySide) {
            const winner = s.players[s.winner];
            const loser = s.players[s.winner === 'A' ? 'B' : 'A'];
            const injuryLog = s.logs.find(l => l.includes("[ë¶€ìƒ]")) || "";

            document.getElementById("noirCard").style.display = "block";
            document.getElementById("copyBtn").style.display = "block";
            document.getElementById("noirSummary").innerText = `${winner.name}, ${loser.name} ì œì•• ì„±ê³µ.`;
            document.getElementById("noirInjury").innerText = injuryLog;
            document.getElementById("noirWinner").innerText = `WINNER: ${winner.name}`;
            document.getElementById("noirDate").innerText = new Date().toLocaleDateString();
        } else {
            // íŒ¨ë°°ìëŠ” ê°€ë¦¼
            document.getElementById("noirCard").style.display = "none";
            document.getElementById("copyBtn").style.display = "none";
        }
    }

    document.getElementById("restartBtn").onclick = () => location.reload();

    // ë³µì‚¬ ê¸°ëŠ¥ ë³´ê°•
    document.getElementById("copyBtn").onclick = async () => {
        const summary = document.getElementById("noirSummary").innerText;
        const injury = document.getElementById("noirInjury").innerText;
        const textToCopy = `[ì „íˆ¬ ê²°ê³¼ ë³´ê³ ]\n${summary}\n${injury}`;

        try {
            await navigator.clipboard.writeText(textToCopy);
            alert("ì „íˆ¬ ê¸°ë¡ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (err) {
            // navigator.clipboardê°€ ì‘ë™í•˜ì§€ ì•ŠëŠ” ê²½ìš° (ì˜ˆ: ë¡œì»¬ í™˜ê²½ ë“±)
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert("ì „íˆ¬ ê¸°ë¡ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. (Alternative)");
        }
    };
</script>
</body>
</html>
