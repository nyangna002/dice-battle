<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Dice Battle - Noir Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PNG ì €ì¥ìš© ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body {
  background:#121212;
  color:#eee;
  font-family:"Noto Serif KR", serif;
  padding:20px;
}

/* ì „íˆ¬ UI */
button {
  padding:10px;
  font-size:16px;
  margin:6px 0;
  cursor:pointer;
}
button:disabled { opacity:.4; }

.hp { height:18px; background:#333; margin-bottom:10px; }
.hp > div { height:100%; transition:.3s; }

.status { font-size:14px; opacity:.85; }
#copySummary { display:none; background:#2c3e50; padding:6px; }

/* ëŠì™€ë¥´ ì¹´ë“œ */
.noir-card {
  width:320px;
  background:#0f0f0f;
  border:1px solid #333;
  padding:18px;
  color:#e0e0e0;
  box-shadow:0 0 25px rgba(0,0,0,0.9);
  margin-top:20px;
}

.noir-title {
  font-size:14px;
  letter-spacing:2px;
  color:#888;
  border-bottom:1px solid #333;
  padding-bottom:6px;
  margin-bottom:12px;
}

.noir-body p {
  font-size:14px;
  line-height:1.6;
  margin:0 0 10px 0;
}

.noir-footer {
  display:flex;
  justify-content:space-between;
  font-size:11px;
  color:#666;
  border-top:1px solid #333;
  padding-top:8px;
  margin-top:12px;
}

.noir-actions {
  margin-top:12px;
  text-align:center;
}

.noir-actions button {
  background:#1a1a1a;
  color:#ccc;
  border:1px solid #333;
  padding:6px 12px;
  cursor:pointer;
  font-size:12px;
}

.noir-actions button:hover {
  background:#222;
}
</style>
</head>

<body>

<div id="room">
  <p>ë‚´ í”Œë ˆì´ì–´: <b id="me"></b></p>
  <p>í„´: <b id="turn"></b></p>

  <b id="nameA"></b>
  <div class="status" id="statusA"></div>
  <div class="hp"><div id="hpA"></div></div>

  <b id="nameB"></b>
  <div class="status" id="statusB"></div>
  <div class="hp"><div id="hpB"></div></div>

  <button id="attack">ğŸ² ê³µê²©</button>
  <button id="restart" style="display:none">ğŸ” ì¬ì‹œì‘</button>
  <button id="copySummary">ğŸ“‹ ì „íˆ¬ ê²°ê³¼ ìš”ì•½ ë³µì‚¬</button>

  <ul id="logs"></ul>
</div>

<!-- ëŠì™€ë¥´ ì¹´ë“œ -->
<div id="noirCard" class="noir-card">
  <div class="noir-title">BATTLE REPORT</div>
  <div class="noir-body">
    <p id="noirSummary"></p>
    <p id="noirInjury"></p>
  </div>
  <div class="noir-footer">
    <span id="noirWinner"></span>
    <span id="noirDate"></span>
  </div>
  <div class="noir-actions">
    <button onclick="saveAsPNG()">PNGë¡œ ì €ì¥</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

/* Firebase ì„¤ì • */
const firebaseConfig = {
  apiKey: "AIzaSyB5DBFCeHAy0ZhM3ITwu4MklaGqtqv9vhU",
  authDomain: "dice-7fe9a.firebaseapp.com",
  databaseURL: "https://dice-7fe9a-default-rtdb.firebaseio.com",
  projectId: "dice-7fe9a"
}

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ìƒíƒœ */
const roomId = new URLSearchParams(location.search).get("room");
const roomRef = ref(db, `rooms/${roomId}`);
const mySide = localStorage.getItem("diceSide");
const myName = localStorage.getItem("diceName");

/* DOM */
const meEl = document.getElementById("me");
const turnEl = document.getElementById("turn");
const nameA = document.getElementById("nameA");
const nameB = document.getElementById("nameB");
const hpA = document.getElementById("hpA");
const hpB = document.getElementById("hpB");
const statusA = document.getElementById("statusA");
const statusB = document.getElementById("statusB");
const btnAttack = document.getElementById("attack");
const btnRestart = document.getElementById("restart");
const btnSummary = document.getElementById("copySummary");
const logsEl = document.getElementById("logs");

meEl.innerText = mySide;

/* ìœ í‹¸ */
const hpColor = hp =>
  hp > 20 ? "#2ecc71" : hp > 10 ? "#f1c40f" : "#e74c3c";
const BODY_PARTS = ["ë¨¸ë¦¬","ì–´ê¹¨","íŒ”","ì†ëª©","ë³µë¶€","ì˜†êµ¬ë¦¬","í—ˆë²…ì§€","ì¢…ì•„ë¦¬"];

/* ì‹¤ì‹œê°„ ë°˜ì˜ */
onValue(roomRef, snap => {
  const s = snap.val();
  if(!s) return;

  turnEl.innerText = s.turn;

  nameA.innerText = s.players.A.name;
  nameB.innerText = s.players.B.name;

  statusA.innerText = s.players.A.bleeding ? "ğŸ©¸ ì¶œí˜ˆ" : "";
  statusB.innerText = s.players.B.bleeding ? "ğŸ©¸ ì¶œí˜ˆ" : "";

  hpA.style.width = (s.players.A.hp/30*100)+"%";
  hpA.style.background = hpColor(s.players.A.hp);
  hpB.style.width = (s.players.B.hp/30*100)+"%";
  hpB.style.background = hpColor(s.players.B.hp);

  btnAttack.disabled = s.status!=="playing" || s.turn!==mySide;
  btnRestart.style.display = s.status==="finished" ? "block":"none";
  btnSummary.style.display = (s.status==="finished" && s.winner===mySide) ? "block":"none";

  logsEl.innerHTML="";
  (s.logs||[]).forEach(l=>{
    const li=document.createElement("li");
    li.innerText=l;
    logsEl.appendChild(li);
  });
});

/* ê³µê²© */
btnAttack.onclick = async ()=>{
  const snap = await get(roomRef);
  const s = snap.val();
  if(!s || s.status!=="playing" || s.turn!==mySide) return;

  const attacker = mySide;
  const target = mySide==="A"?"B":"A";
  const targetName = s.players[target].name;

  let updates = {};
  let logs = [...(s.logs||[])];

  /* ì¶œí˜ˆ ë°ë¯¸ì§€ */
  if(s.players[attacker].bleeding){
    updates[`players/${attacker}/hp`] = s.players[attacker].hp-2;
    logs.push(`ğŸ©¸ ${myName}: ì¶œí˜ˆë¡œ ì²´ë ¥ì„ ìƒì—ˆë‹¤ (-2)`);
  }

  const dice = Math.floor(Math.random()*20)+1;
  let newHp = s.players[target].hp - dice;

  logs.push(`âš”ï¸ ${myName}ì˜ ê³µê²© (${dice})`);

  /* ì¶œí˜ˆ ë¶€ì—¬ */
  let bleeding = s.players[target].bleeding || false;
  if(dice>=15 && Math.random()<0.3){
    bleeding = true;
    logs.push(`ğŸ©¸ ${targetName}: ì¶œí˜ˆ ìƒíƒœì— ë¹ ì¡Œë‹¤`);
  }

  updates[`players/${target}/hp`] = newHp;
  updates[`players/${target}/bleeding`] = bleeding;
  updates.turn = target;
  updates.logs = logs;

  /* ì „íˆ¬ ì¢…ë£Œ */
  if(newHp <=0){
    const part = BODY_PARTS[Math.floor(Math.random()*BODY_PARTS.length)];
    updates.status = "finished";
    updates.winner = mySide;
    updates.logs = [...logs, `ğŸ† ${myName} ìŠ¹ë¦¬`,`ğŸ’¥ ${targetName}, ${part}ì— ë¶€ìƒì„ ì…ì—ˆìŠµë‹ˆë‹¤.`];

    /* ëŠì™€ë¥´ ì¹´ë“œ í‘œì‹œ */
    showNoirCard({
      winnerName: myName,
      loserName: targetName,
      injuryPart: part
    });
  }

  await update(roomRef, updates);
};

/* ì¬ì‹œì‘ */
btnRestart.onclick = async ()=>{
  await update(roomRef,{
    players:{
      A:{name:nameA.innerText,hp:30,bleeding:false},
      B:{name:nameB.innerText,hp:30,bleeding:false}
    },
    turn:"A",
    status:"playing",
    winner:null,
    logs:["ğŸ” ìƒˆë¡œìš´ êµì „ì´ ì‹œì‘ë˜ì—ˆë‹¤"]
  });
};

/* ì „íˆ¬ ê²°ê³¼ ìš”ì•½ ë³µì‚¬ */
btnSummary.onclick = async ()=>{
  const snap = await get(roomRef);
  const s = snap.val();
  if(!s || s.winner!==mySide) return;

  const loserSide = mySide==="A"?"B":"A";
  const loserName = s.players[loserSide].name;
  const attacks = s.logs.filter(l=>l.includes("âš”ï¸")).length;
  const injury = s.logs.find(l=>l.includes("ğŸ’¥"))||"";

  const summary = `[ì „íˆ¬ ê²°ê³¼ ë³´ê³ ]
${myName}, ${attacks}íšŒì˜ êµì „ì„ í†µí•´ ${loserName} ì œì•• ì™„ë£Œ.
${injury}`.trim();

  await navigator.clipboard.writeText(summary);
  alert("ì „íˆ¬ ê²°ê³¼ ìš”ì•½ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤");
};

/* ---------------- ëŠì™€ë¥´ ì¹´ë“œ ---------------- */
function showNoirCard({winnerName,loserName,injuryPart}){
  document.getElementById("noirSummary").innerText =
    `${winnerName}, ${loserName} ì œì•• ì„±ê³µ.`;
  document.getElementById("noirInjury").innerText =
    `${loserName}, ${injuryPart}ì— ë¶€ìƒì„ ì…ê³  ì „íˆ¬ê°€ ì¢…ë£Œë˜ì—ˆë‹¤.`;
  document.getElementById("noirWinner").innerText = `WINNER: ${winnerName}`;
  document.getElementById("noirDate").innerText = new Date().toLocaleDateString();
}

/* PNG ì €ì¥ */
function saveAsPNG(){
  const card = document.getElementById("noirCard");
  html2canvas(card,{backgroundColor:"#0f0f0f"}).then(canvas=>{
    const link = document.createElement("a");
    link.download = "battle_report.png";
    link.href = canvas.toDataURL();
    link.click();
  });
}
</script>
</body>
</html>
