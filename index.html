<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Dice Battle</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: system-ui, sans-serif;
  background: #111;
  color: #eee;
  margin: 0;
  padding: 20px;
}
button {
  padding: 12px 16px;
  font-size: 16px;
  margin: 6px 0;
}
input {
  padding: 10px;
  font-size: 16px;
  width: 120px;
}
#room { display: none; }
.hp {
  height: 20px;
  background: #333;
  margin-bottom: 6px;
}
.hp > div {
  height: 100%;
  transition: width 0.3s;
}
.log {
  font-size: 14px;
  opacity: 0.9;
}
.me { color: #7fdcff; }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getDatabase, ref, get, set, update, onValue
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

/* ðŸ”¥ Firebase ì„¤ì •ê°’ êµì²´ */
const firebaseConfig = {
  apiKey: "AIzaSyB5DBFCeHAy0ZhM3ITwu4MklaGqtqv9vhU",
  authDomain: "dice-7fe9a.firebaseapp.com",
  databaseURL: "https://dice-7fe9a-default-rtdb.firebaseio.com",
  projectId: "dice-7fe9a"
    }

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const qs = new URLSearchParams(location.search);
let roomId = qs.get("room");
let mySide = null;
let myName = null;

const lobby = document.getElementById("lobby");
const room = document.getElementById("room");

/* ìœ í‹¸ */
function makeCode() {
  return Math.random().toString(36).substring(2, 6).toUpperCase();
}
function hpColor(hp) {
  if (hp > 20) return "#3cb371";
  if (hp > 10) return "#f1c40f";
  return "#e74c3c";
}

/* DOM */
document.body.innerHTML = `
<div id="lobby">
  <h2>ðŸŽ² Dice Battle</h2>
  <button id="create">ë°© ë§Œë“¤ê¸°</button><br><br>
  <input id="code" placeholder="ë°© ì½”ë“œ">
  <button id="join">ìž…ìž¥</button>
</div>

<div id="room">
  <h3>ë°© ì½”ë“œ: <span id="roomCode"></span></h3>
  <p>í„´: <b id="turn"></b></p>

  <div>
    <b id="nameA"></b>
    <div class="hp"><div id="hpA"></div></div>
  </div>

  <div>
    <b id="nameB"></b>
    <div class="hp"><div id="hpB"></div></div>
  </div>

  <button id="attack">ðŸŽ² ê³µê²©</button>
  <ul id="logs"></ul>
</div>
`;

const btnCreate = document.getElementById("create");
const btnJoin = document.getElementById("join");
const btnAttack = document.getElementById("attack");

/* ë°© ìƒì„± */
btnCreate.onclick = async () => {
  myName = prompt("ì´ë¦„ ìž…ë ¥");
  if (!myName) return;

  roomId = makeCode();
  mySide = "A";

  await set(ref(db, `rooms/${roomId}`), {
    players: {
      A: { name: myName, hp: 30 },
      B: null
    },
    turn: "A",
    logs: [],
    status: "playing"
  });

  location.search = `?room=${roomId}`;
};

/* ë°© ìž…ìž¥ */
btnJoin.onclick = async () => {
  const code = document.getElementById("code").value.trim().toUpperCase();
  if (!code) return;

  const snap = await get(ref(db, `rooms/${code}`));
  if (!snap.exists()) {
    alert("ë°©ì´ ì—†ìŠµë‹ˆë‹¤");
    return;
  }

  const data = snap.val();

if (
  data.players.A?.name === myName ||
  data.players.B?.name === myName
) {
  alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë¦„ìž…ë‹ˆë‹¤");
  return;
}


  myName = prompt("ì´ë¦„ ìž…ë ¥");
  if (!myName) return;

  const data = snap.val();
  if (data.players.B) {
    alert("ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤");
    return;
  }

  mySide = "B";
  await update(ref(db, `rooms/${code}/players/B`), {
    name: myName,
    hp: 30
  });

  location.search = `?room=${code}`;
};

/* ë°© ìƒíƒœ êµ¬ë… */
if (roomId) {
  const roomRef = ref(db, `rooms/${roomId}`);
  document.getElementById("lobby").style.display = "none";
  document.getElementById("room").style.display = "block";
  document.getElementById("roomCode").innerText = roomId;

  onValue(roomRef, snap => {
    const s = snap.val();
    if (!s) return;

    nameA.innerText = s.players.A?.name || "ëŒ€ê¸° ì¤‘";
    nameB.innerText = s.players.B?.name || "ëŒ€ê¸° ì¤‘";
    turn.innerText = s.turn;

    const hpAVal = s.players.A?.hp ?? 0;
    const hpBVal = s.players.B?.hp ?? 0;

    hpA.style.width = `${hpAVal / 30 * 100}%`;
    hpA.style.background = hpColor(hpAVal);
    hpB.style.width = `${hpBVal / 30 * 100}%`;
    hpB.style.background = hpColor(hpBVal);

    btnAttack.disabled =
      s.status !== "playing" ||
      s.turn !== mySide ||
      !s.players.A || !s.players.B;

 logs.innerHTML = "";

const logList = s.logs || [];

logList.forEach(l => {
  const li = document.createElement("li");
  li.className = "log";
  li.innerText = l;
  logs.appendChild(li);
});

  });

  /* ê³µê²© */
  btnAttack.onclick = async () => {
    const snap = await get(roomRef);
    const s = snap.val();
    if (!s || s.turn !== mySide || s.status !== "playing") return;

    const target = mySide === "A" ? "B" : "A";
    const dice = Math.floor(Math.random() * 20) + 1;
    const newHp = s.players[target].hp - dice;

    const updates = {
      [`players/${target}/hp`]: newHp,
      turn: target,
      logs: [...s.logs, `${myName} â†’ d20 (${dice})`]
    };

    if (newHp <= 0) {
      updates.status = "finished";
      updates.logs.push(`ðŸ† ${myName} ìŠ¹ë¦¬!`);
    }

    await update(roomRef, updates);
  };
}
</script>
</head>
<body></body>
</html>
