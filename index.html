<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Dice Battle</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  background:#111;
  color:#eee;
  font-family:system-ui;
  padding:20px;
}
button { padding:10px; font-size:16px; }
button:disabled { opacity:.4; }
.hp { height:18px; background:#333; margin-bottom:10px; }
.hp > div { height:100%; transition:.3s; }
</style>
</head>

<body>
<div id="room">
  <p>ë‚´ í”Œë ˆì´ì–´: <b id="me"></b></p>
  <p>í„´: <b id="turn"></b></p>

  <b id="nameA"></b>
  <div class="hp"><div id="hpA"></div></div>

  <b id="nameB"></b>
  <div class="hp"><div id="hpB"></div></div>

  <button id="attack">ğŸ² ê³µê²©</button>
  <button id="restart" style="display:none">ğŸ” ì¬ì‹œì‘</button>

  <ul id="logs"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyB5DBFCeHAy0ZhM3ITwu4MklaGqtqv9vhU",
  authDomain: "dice-7fe9a.firebaseapp.com",
  databaseURL: "https://dice-7fe9a-default-rtdb.firebaseio.com",
  projectId: "dice-7fe9a"
}

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ìƒíƒœ */
const roomId = new URLSearchParams(location.search).get("room");
const roomRef = ref(db, `rooms/${roomId}`);
const mySide = localStorage.getItem("diceSide");
const myName = localStorage.getItem("diceName");

/* DOM */
const meEl = document.getElementById("me");
const turnEl = document.getElementById("turn");
const nameA = document.getElementById("nameA");
const nameB = document.getElementById("nameB");
const hpA = document.getElementById("hpA");
const hpB = document.getElementById("hpB");
const btnAttack = document.getElementById("attack");
const btnRestart = document.getElementById("restart");
const logsEl = document.getElementById("logs");

meEl.innerText = mySide;

/* ìƒ‰ */
const hpColor = hp =>
  hp > 20 ? "#2ecc71" : hp > 10 ? "#f1c40f" : "#e74c3c";

/* ì‹¤ì‹œê°„ ë°˜ì˜ */
onValue(roomRef, snap => {
  const s = snap.val();
  if (!s) return;

  turnEl.innerText = s.turn;

  nameA.innerText = s.players.A.name;
  nameB.innerText = s.players.B.name;

  hpA.style.width = (s.players.A.hp / 30 * 100) + "%";
  hpA.style.background = hpColor(s.players.A.hp);
  hpB.style.width = (s.players.B.hp / 30 * 100) + "%";
  hpB.style.background = hpColor(s.players.B.hp);

  btnAttack.disabled =
    s.status !== "playing" || s.turn !== mySide;

  btnRestart.style.display =
    s.status === "finished" ? "block" : "none";

  logsEl.innerHTML = "";
  (s.logs || []).forEach(l => {
    const li = document.createElement("li");
    li.innerText = l;
    logsEl.appendChild(li);
  });
});

/* ê³µê²© (ğŸ”¥ í•µì‹¬ ìˆ˜ì •ë¨) */
btnAttack.onclick = async () => {
  const snap = await get(roomRef);
  const s = snap.val();
  if (!s || s.status !== "playing" || s.turn !== mySide) return;

  const target = mySide === "A" ? "B" : "A";
  const dice = Math.floor(Math.random() * 20) + 1;
  const newHp = s.players[target].hp - dice;

  const logs = [...(s.logs || []),
    `âš”ï¸ ${myName}ì˜ ê³µê²©! (${dice})`
  ];

  const updates = {
    [`players/${target}/hp`]: newHp,
    turn: target,
    logs
  };

  if (newHp <= 0) {
    updates.status = "finished";
    updates.logs = [...logs, `ğŸ† ${myName} ìŠ¹ë¦¬!`];
  }

  await update(roomRef, updates);
};

/* ì¬ì‹œì‘ */
btnRestart.onclick = async () => {
  await update(roomRef, {
    players: {
      A: { name: nameA.innerText, hp: 30 },
      B: { name: nameB.innerText, hp: 30 }
    },
    turn: "A",
    status: "playing",
    logs: ["ğŸ” ì „íˆ¬ ì¬ì‹œì‘"]
  });
};
</script>
</body>
</html>
