<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Dice Battle - Noir Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    body{background:#121212;color:#eee;font-family:"Noto Serif KR", serif;padding:20px;}
    input, button{padding:8px;margin:4px;font-size:14px; background:#222; color:#fff; border:1px solid #444;}
    button:hover{background:#333;}
    button:disabled{opacity:.4;cursor:not-allowed;}
    .hp{height:18px;background:#333;margin-bottom:10px; border-radius:3px; overflow:hidden;}
    .hp>div{height:100%;transition:.3s;}
    .status{font-size:14px;opacity:.85; height:20px;}
    .noir-card{
      display:none; /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
      width:320px; background:#0f0f0f; border:2px solid #333; padding:18px;
      color:#e0e0e0; box-shadow:0 0 25px rgba(0,0,0,0.9); margin-top:20px;
    }
    .noir-title{font-size:14px;letter-spacing:2px;color:#888;border-bottom:1px solid #333;padding-bottom:6px;margin-bottom:12px;}
    .noir-footer{display:flex;justify-content:space-between;font-size:11px;color:#666;border-top:1px solid #333;padding-top:8px;margin-top:12px;}
    #logs{max-height:150px; overflow-y:auto; font-size:13px; list-style:none; padding:0; border-left:2px solid #333; padding-left:10px;}
</style>
</head>
<body>

<h3>ë°© ë§Œë“¤ê¸° / ì…ì¥</h3>
<input id="roomInput" placeholder="ë°© ë²ˆí˜¸ ì…ë ¥"/>
<button id="createRoom">ë°© ë§Œë“¤ê¸°</button>
<button id="enterRoom">ì…ì¥</button>
<p id="roomLink"></p>

<hr>

<div id="roomUI" style="display:none;">
    <p>ë‚´ í”Œë ˆì´ì–´: <b id="me"></b> (<span id="myNameDisplay"></span>)</p>
    <p>í„´: <b id="turn"></b></p>

    <b id="nameA"></b> <span id="statusA" class="status"></span>
    <div class="hp"><div id="hpA"></div></div>

    <b id="nameB"></b> <span id="statusB" class="status"></span>
    <div class="hp"><div id="hpB"></div></div>

    <button id="attack">ğŸ² ê³µê²©</button>
    <button id="restart" style="display:none">ì¬ì‹œì‘</button>
    <button id="copySummary" style="display:none">ğŸ“‹ ì „íˆ¬ ê²°ê³¼ ìš”ì•½ ë³µì‚¬</button>

    <ul id="logs"></ul>

    <div id="noirCard" class="noir-card">
        <div class="noir-title">BATTLE REPORT</div>
        <div class="noir-body">
            <p id="noirSummary"></p>
            <p id="noirInjury"></p>
        </div>
        <div class="noir-footer">
            <span id="noirWinner"></span>
            <span id="noirDate"></span>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, get, set, update, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

/* Firebase ì„¤ì • (ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”) */
const firebaseConfig = {
  apiKey: "AIzaSyB5DBFCeHAy0ZhM3ITwu4MklaGqtqv9vhU",
  authDomain: "dice-7fe9a.firebaseapp.com",
  databaseURL: "https://dice-7fe9a-default-rtdb.firebaseio.com",
  projectId: "dice-7fe9a"
}
    
    ;

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let roomId="", mySide="", myName="";
const BODY_PARTS=["ë¨¸ë¦¬","ì–´ê¹¨","íŒ”","ì†ëª©","ë³µë¶€","ì˜†êµ¬ë¦¬","í—ˆë²…ì§€","ì¢…ì•„ë¦¬"];
const hpColor = hp => hp > 30 ? "#2ecc71" : hp > 15 ? "#f1c40f" : "#e74c3c";

// DOM ìš”ì†Œ
const roomInput=document.getElementById("roomInput");
const createRoomBtn=document.getElementById("createRoom");
const enterRoomBtn=document.getElementById("enterRoom");
const roomUI=document.getElementById("roomUI");
const turnEl=document.getElementById("turn");
const logsEl=document.getElementById("logs");
const btnAttack=document.getElementById("attack");

// URL íŒŒë¼ë¯¸í„° í™•ì¸
const urlParams = new URLSearchParams(window.location.search);
if(urlParams.get('room')) roomInput.value = urlParams.get('room');

/* UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ */
function updateUI(s){
    if(!s) return;
    turnEl.innerText = s.turn === mySide ? "ë‚´ ì°¨ë¡€" : "ìƒëŒ€ ì°¨ë¡€";
    document.getElementById("nameA").innerText = s.players?.A?.name || "ëŒ€ê¸°ì¤‘";
    document.getElementById("nameB").innerText = s.players?.B?.name || "ëŒ€ê¸°ì¤‘";
    document.getElementById("statusA").innerText = s.players?.A?.bleeding ? " ğŸ©¸ ì¶œí˜ˆ" : "";
    document.getElementById("statusB").innerText = s.players?.B?.bleeding ? " ğŸ©¸ ì¶œí˜ˆ" : "";
    
    const hpAVal = s.players?.A?.hp ?? 50;
    const hpBVal = s.players?.B?.hp ?? 50;
    document.getElementById("hpA").style.width = (hpAVal/50*100) + "%";
    document.getElementById("hpA").style.background = hpColor(hpAVal);
    document.getElementById("hpB").style.width = (hpBVal/50*100) + "%";
    document.getElementById("hpB").style.background = hpColor(hpBVal);

    btnAttack.disabled = s.status !== "playing" || s.turn !== mySide;
    document.getElementById("restart").style.display = s.status === "finished" ? "block" : "none";
    document.getElementById("copySummary").style.display = (s.status === "finished" && s.winner === mySide) ? "block" : "none";

    logsEl.innerHTML = "";
    (s.logs || []).slice().reverse().forEach(l => {
        const li = document.createElement("li");
        li.innerText = l;
        logsEl.appendChild(li);
    });

    if(s.status === "finished") {
        const winnerSide = s.winner;
        const loserSide = winnerSide === "A" ? "B" : "A";
        const injuryLog = s.logs.find(l => l.includes("ë¶€ìƒ")) || "";
        showNoirCard({
            winnerName: s.players[winnerSide].name,
            loserName: s.players[loserSide].name,
            injuryPart: injuryLog.split(" ")[2] || "ì „ì‹ "
        });
    } else {
        document.getElementById("noirCard").style.display = "none";
    }
}

function showNoirCard({winnerName, loserName, injuryPart}){
    document.getElementById("noirCard").style.display = "block";
    document.getElementById("noirSummary").innerText = `${winnerName}, ${loserName} ì œì•• ì„±ê³µ.`;
    document.getElementById("noirInjury").innerText = `${loserName}, ${injuryPart} ë¶€ìƒì„ ì…ê³  ì „íˆ¬ ë¶ˆëŠ¥.`;
    document.getElementById("noirWinner").innerText = `WINNER: ${winnerName}`;
    document.getElementById("noirDate").innerText = new Date().toLocaleDateString();
}

/* ë°© ì…ì¥ ë¡œì§ */
async function joinRoom(targetId, name){
    roomId = targetId; 
    myName = name;
    const roomRef = ref(db, `rooms/${roomId}`);
    let snap = await get(roomRef);
    
    if(!snap.exists()) return alert("ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    let data = snap.val();

    if(!data.players.A.name || data.players.A.name === "ëŒ€ê¸°ì¤‘"){
        mySide = "A";
        await update(ref(db, `rooms/${roomId}/players/A`), {name: myName});
    } else if(!data.players.B.name || data.players.B.name === "ëŒ€ê¸°ì¤‘"){
        mySide = "B";
        await update(ref(db, `rooms/${roomId}/players/B`), {name: myName});
        await update(roomRef, {status: "playing", logs: [...(data.logs||[]), "ì „íˆ¬ ê°œì‹œ"]});
    } else {
        return alert("ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.");
    }

    document.getElementById("me").innerText = mySide;
    document.getElementById("myNameDisplay").innerText = myName;
    roomUI.style.display = "block";

    onValue(roomRef, (snapshot) => {
        updateUI(snapshot.val());
    });
}

createRoomBtn.onclick = async () => {
    const inputId = roomInput.value.trim();
    if(!inputId) return alert("ë°© ë²ˆí˜¸ ì…ë ¥!");
    myName = prompt("ì´ë¦„ ì…ë ¥") || "Player1";
    
    const roomRef = ref(db, `rooms/${inputId}`);
    await set(roomRef, {
        players: {
            A: {name: myName, hp: 50, bleeding: false},
            B: {name: "ëŒ€ê¸°ì¤‘", hp: 50, bleeding: false}
        },
        turn: "A",
        status: "waiting",
        logs: ["ìƒˆë¡œìš´ ì „íˆ¬ ìƒì„±"]
    });
    mySide = "A";
    roomId = inputId;
    document.getElementById("me").innerText = mySide;
    document.getElementById("myNameDisplay").innerText = myName;
    roomUI.style.display = "block";
    onValue(roomRef, snap => updateUI(snap.val()));
};

enterRoomBtn.onclick = () => {
    const inputId = roomInput.value.trim();
    if(!inputId) return alert("ë°© ë²ˆí˜¸ ì…ë ¥!");
    const name = prompt("ì´ë¦„ ì…ë ¥") || "Player2";
    joinRoom(inputId, name);
};

btnAttack.onclick = async () => {
    const roomRef = ref(db, `rooms/${roomId}`);
    const snap = await get(roomRef);
    const s = snap.val();
    
    const attacker = mySide;
    const target = mySide === "A" ? "B" : "A";
    let updates = {};
    let logs = s.logs || [];
    
    let currentTargetHp = s.players[target].hp;
    let currentAttackerHp = s.players[attacker].hp;

    // ì¶œí˜ˆ ë°ë¯¸ì§€ ì²˜ë¦¬
    if(s.players[attacker].bleeding){
        currentAttackerHp -= 2;
        logs.push(`ğŸ©¸ ${myName} ì¶œí˜ˆ ë°ë¯¸ì§€ (-2)`);
        updates[`players/${attacker}/hp`] = currentAttackerHp;
    }

    const dice = Math.floor(Math.random() * 20) + 1;
    currentTargetHp -= dice;
    logs.push(`âš”ï¸ ${myName}ì˜ ê³µê²©! [${dice}] ë°ë¯¸ì§€`);

    if(dice >= 15 && Math.random() < 0.4){
        updates[`players/${target}/bleeding`] = true;
        logs.push(`ğŸ©¸ ${s.players[target].name}ì—ê²Œ ì¹˜ëª…ìƒ, ì¶œí˜ˆ ë°œìƒ!`);
    }

    updates[`players/${target}/hp`] = currentTargetHp;
    updates[`turn`] = target;
    
    if(currentTargetHp <= 0 || currentAttackerHp <= 0){
        const winner = currentTargetHp <= 0 ? attacker : target;
        const loser = winner === "A" ? "B" : "A";
        const part = BODY_PARTS[Math.floor(Math.random()*BODY_PARTS.length)];
        updates[`status`] = "finished";
        updates[`winner`] = winner;
        logs.push(`ğŸ† ${s.players[winner].name} ìŠ¹ë¦¬!`);
        logs.push(`ğŸ’¥ ${s.players[loser].name} ${part} ë¶€ìƒìœ¼ë¡œ ë¦¬íƒ€ì´ì–´`);
    }

    updates[`logs`] = logs;
    await update(roomRef, updates);
};

document.getElementById("restart").onclick = async () => {
    const roomRef = ref(db, `rooms/${roomId}`);
    const snap = await get(roomRef);
    const s = snap.val();
    await update(roomRef, {
        players: {
            A: {name: s.players.A.name, hp: 50, bleeding: false},
            B: {name: s.players.B.name, hp: 50, bleeding: false}
        },
        turn: "A",
        status: "playing",
        logs: ["ì „íˆ¬ ì¬ì‹œì‘"]
    });
};
</script>
</body>
</html>
