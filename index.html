<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Dice Battle</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  padding: 20px;
  background: #111;
  color: #eee;
  font-family: system-ui, sans-serif;
}
button {
  padding: 10px 14px;
  font-size: 16px;
  margin: 6px 0;
}
button:disabled {
  opacity: 0.4;
}
input {
  padding: 8px;
  font-size: 16px;
}
.hp {
  width: 100%;
  height: 18px;
  background: #333;
  margin-bottom: 10px;
}
.hp > div {
  height: 100%;
  transition: width 0.3s;
}
.log {
  font-size: 14px;
  opacity: 0.9;
}
</style>
</head>

<body>
<div id="lobby">
  <h2>ğŸ² Dice Battle</h2>
  <button id="create">ë°© ë§Œë“¤ê¸°</button><br><br>
  <input id="code" placeholder="ë°© ì½”ë“œ">
  <button id="join">ì…ì¥</button>
</div>

<div id="room" style="display:none">
  <h3>ë°© ì½”ë“œ: <span id="roomCode"></span></h3>
  <p>ë‚´ í”Œë ˆì´ì–´: <b id="me"></b></p>
  <p>í„´: <b id="turn"></b></p>

  <div>
    <b id="nameA"></b>
    <div class="hp"><div id="hpA"></div></div>
  </div>

  <div>
    <b id="nameB"></b>
    <div class="hp"><div id="hpB"></div></div>
  </div>

  <button id="attack">ğŸ² ê³µê²©</button>
  <ul id="logs"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getDatabase, ref, get, set, update, onValue
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

/* ğŸ”¥ Firebase ì„¤ì • (êµì²´ í•„ìˆ˜) */
const firebaseConfig = {
  apiKey: "AIzaSyB5DBFCeHAy0ZhM3ITwu4MklaGqtqv9vhU",
  authDomain: "dice-7fe9a.firebaseapp.com",
  databaseURL: "https://dice-7fe9a-default-rtdb.firebaseio.com",
  projectId: "dice-7fe9a"
}

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* URL */
const qs = new URLSearchParams(location.search);
const roomId = qs.get("room");

/* localStorage ë³µì› */
let myName = localStorage.getItem("diceName");
let mySide = localStorage.getItem("diceSide");

/* DOM */
const lobby = document.getElementById("lobby");
const room = document.getElementById("room");
const btnCreate = document.getElementById("create");
const btnJoin = document.getElementById("join");
const btnAttack = document.getElementById("attack");

const nameA = document.getElementById("nameA");
const nameB = document.getElementById("nameB");
const hpA = document.getElementById("hpA");
const hpB = document.getElementById("hpB");
const turnEl = document.getElementById("turn");
const meEl = document.getElementById("me");
const logsEl = document.getElementById("logs");

/* ìœ í‹¸ */
function makeCode() {
  return Math.random().toString(36).substring(2, 6).toUpperCase();
}
function hpColor(hp) {
  if (hp > 20) return "#2ecc71";
  if (hp > 10) return "#f1c40f";
  return "#e74c3c";
}

/* ë°© ë§Œë“¤ê¸° */
btnCreate.onclick = async () => {
  myName = prompt("ì´ë¦„ ì…ë ¥");
  if (!myName) return;

  const code = makeCode();
  mySide = "A";

  await set(ref(db, `rooms/${code}`), {
    players: {
      A: { name: myName, hp: 30 },
      B: null
    },
    turn: "A",
    status: "playing",
    logs: []
  });

  localStorage.setItem("diceName", myName);
  localStorage.setItem("diceSide", mySide);
  localStorage.setItem("diceRoom", code);

  location.search = `?room=${code}`;
};

/* ë°© ì…ì¥ */
btnJoin.onclick = async () => {
  const code = document.getElementById("code").value.trim().toUpperCase();
  if (!code) return;

  const snap = await get(ref(db, `rooms/${code}`));
  if (!snap.exists()) {
    alert("ë°©ì´ ì—†ìŠµë‹ˆë‹¤");
    return;
  }

  myName = prompt("ì´ë¦„ ì…ë ¥");
  if (!myName) return;

  const data = snap.val();

  if (
    data.players.A?.name === myName ||
    data.players.B?.name === myName
  ) {
    alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë¦„ì…ë‹ˆë‹¤");
    return;
  }

  if (data.players.B) {
    alert("ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤");
    return;
  }

  mySide = "B";

  await update(ref(db, `rooms/${code}/players/B`), {
    name: myName,
    hp: 30
  });

  localStorage.setItem("diceName", myName);
  localStorage.setItem("diceSide", mySide);
  localStorage.setItem("diceRoom", code);

  location.search = `?room=${code}`;
};

/* ë°© í™”ë©´ */
if (roomId) {
  lobby.style.display = "none";
  room.style.display = "block";
  document.getElementById("roomCode").innerText = roomId;

  if (localStorage.getItem("diceRoom") !== roomId) {
    localStorage.removeItem("diceName");
    localStorage.removeItem("diceSide");
    myName = null;
    mySide = null;
    localStorage.setItem("diceRoom", roomId);
  }

  const roomRef = ref(db, `rooms/${roomId}`);

  onValue(roomRef, snap => {
    const s = snap.val();
    if (!s) return;

    if (!mySide && myName) {
      if (s.players.A?.name === myName) mySide = "A";
      if (s.players.B?.name === myName) mySide = "B";
    }

    meEl.innerText = mySide || "?";
    turnEl.innerText = s.turn;

    nameA.innerText = s.players.A?.name || "ëŒ€ê¸° ì¤‘";
    nameB.innerText = s.players.B?.name || "ëŒ€ê¸° ì¤‘";

    const hpAVal = s.players.A?.hp ?? 0;
    const hpBVal = s.players.B?.hp ?? 0;

    hpA.style.width = (hpAVal / 30 * 100) + "%";
    hpA.style.background = hpColor(hpAVal);
    hpB.style.width = (hpBVal / 30 * 100) + "%";
    hpB.style.background = hpColor(hpBVal);

    btnAttack.disabled =
      s.status !== "playing" ||
      s.turn !== mySide ||
      !s.players.A ||
      !s.players.B;

    logsEl.innerHTML = "";
    (s.logs || []).forEach(l => {
      const li = document.createElement("li");
      li.className = "log";
      li.innerText = l;
      logsEl.appendChild(li);
    });
  });

  btnAttack.onclick = async () => {
    const snap = await get(roomRef);
    const s = snap.val();
    if (!s || s.turn !== mySide || s.status !== "playing") return;

    const target = mySide === "A" ? "B" : "A";
    const dice = Math.floor(Math.random() * 20) + 1;
    const newHp = s.players[target].hp - dice;

    const newLogs = [...(s.logs || []), `${myName} â†’ d20 (${dice})`];

    const updates = {
      [`players/${target}/hp`]: newHp,
      turn: target,
      logs: newLogs
    };

    if (newHp <= 0) {
      updates.status = "finished";
      updates.logs = [...newLogs, `ğŸ† ${myName} ìŠ¹ë¦¬!`];
    }

    await update(roomRef, updates);
  };
}
</script>
</body>
</html>
