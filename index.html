<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Dice Battle - Mobile Optimized</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { background:#121212; color:#eee; font-family:"Noto Serif KR", serif; padding:15px; margin:0; display:flex; flex-direction:column; align-items:center; touch-action: manipulation; }
        .container { max-width: 400px; width: 100%; box-sizing: border-box; }
        input, button { padding:14px; margin:6px 0; font-size:15px; width: 100%; box-sizing: border-box; background:#1e1e1e; color:#fff; border:1px solid #333; border-radius: 8px; }
        button:active { background:#333; transform: scale(0.98); }
        button:disabled { opacity:.3; cursor:not-allowed; transform: none; }
        .hp-bar { height:20px; background:#333; margin: 8px 0 18px 0; border-radius:10px; overflow:hidden; border: 1px solid #444; }
        .hp-fill { height:100%; transition: width 0.4s ease; width: 100%; }
        .status-text { font-size:14px; color:#aaa; display: flex; justify-content: space-between; }
        #logs { 
            background: #0a0a0a; border: 1px solid #222; padding: 12px; height: 180px; 
            overflow-y: auto; font-size: 13px; list-style: none; margin-top: 15px; border-radius: 8px;
        }
        #logs li { border-bottom: 1px solid #1a1a1a; padding: 6px 0; color: #ccc; line-height: 1.4; }
        .room-badge { background: #f1c40f; color: #000; padding: 3px 10px; border-radius: 15px; font-weight: bold; font-size: 13px; }
        .noir-card {
            display:none; background:#000; border:1px solid #444; padding:20px;
            color:#fff; box-shadow:0 10px 30px rgba(0,0,0,0.8); margin-top:20px; border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; letter-spacing:4px; margin: 20px 0;">DICE BATTLE</h2>
    
    <div id="setupUI">
        <input id="roomInput" type="tel" placeholder="ë°© ë²ˆí˜¸(ìˆ«ì)ë¥¼ ì…ë ¥í•˜ì„¸ìš”"/>
        <button id="createRoom" style="background: #2c3e50;">ìƒˆ ì „ì¥ ìƒì„±</button>
        <button id="enterRoom">ì „ì¥ ì°¸ì—¬</button>
    </div>

    <div id="gameUI" style="display:none;">
        <div style="text-align:center; margin-bottom:15px;">
            <span class="room-badge" id="roomDisplay">ROOM ID</span>
        </div>
        
        <p style="text-align:center; color:#888; font-size:13px; margin:5px 0;">
            <b id="meDisplay" style="color:#eee"></b> <span id="mySideDisplay"></span>
        </p>
        <h3 id="turnDisplay" style="text-align:center; color:#f1c40f; height: 24px; margin: 15px 0;">ëŒ€ê¸° ì¤‘...</h3>

        <div class="status-text"><span id="nameA">í”Œë ˆì´ì–´ A</span> <b id="bleedingA"></b></div>
        <div class="hp-bar"><div id="hpA" class="hp-fill"></div></div>

        <div class="status-text"><span id="nameB">í”Œë ˆì´ì–´ B</span> <b id="bleedingB"></b></div>
        <div class="hp-bar"><div id="hpB" class="hp-fill"></div></div>

        <button id="attackBtn" disabled style="background:#8e44ad; font-weight:bold; font-size: 18px;">ğŸ² ê³µê²©í•˜ê¸°</button>
        <button id="restartBtn" style="display:none; background:#34495e;">ì „ì¥ ì´íƒˆ (ì´ˆê¸°í™”)</button>
        <button id="copyBtn" style="display:none; background:#27ae60;">ğŸ“‹ ê²°ê³¼ ìš”ì•½ ë³µì‚¬</button>

        <ul id="logs"></ul>

        <div id="noirCard" class="noir-card">
            <div style="font-size:11px; color:#666; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:10px;">BATTLE REPORT</div>
            <p id="noirSummary" style="font-size:15px; margin:0; line-height:1.6;"></p>
            <p id="noirInjury" style="font-size:13px; color:#888; margin-top:8px;"></p>
            <div style="display:flex; justify-content:space-between; font-size:11px; color:#444; margin-top:15px;">
                <span id="noirWinner"></span>
                <span id="noirDate"></span>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyB5DBFCeHAy0ZhM3ITwu4MklaGqtqv9vhU",
  authDomain: "dice-7fe9a.firebaseapp.com",
  databaseURL: "https://dice-7fe9a-default-rtdb.firebaseio.com",
  projectId: "dice-7fe9a"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let roomId = "", mySide = "", myName = "";
    let isProcessing = false; // ì¤‘ë³µ í´ë¦­ ë°©ì§€ í”Œë˜ê·¸

    const setupUI = document.getElementById("setupUI");
    const gameUI = document.getElementById("gameUI");
    const logsEl = document.getElementById("logs");

    const scrollLogs = () => { logsEl.scrollTop = logsEl.scrollHeight; };

    document.getElementById("createRoom").onclick = async () => {
        const id = document.getElementById("roomInput").value.trim();
        if(!id) return alert("ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        myName = prompt("ë‹¹ì‹ ì˜ ì´ë¦„?") || "ë¬´ëª…ê°";
        roomId = id; mySide = "A";
        
        await set(ref(db, `rooms/${roomId}`), {
            players: { A: { name: myName, hp: 50, bleeding: false }, B: { name: "ëŒ€ê¸° ì¤‘...", hp: 50, bleeding: false } },
            turn: "A", status: "waiting", logs: ["ìƒˆë¡œìš´ ì „ì¥ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."]
        });
        startGamelistener();
    };

    document.getElementById("enterRoom").onclick = async () => {
        const id = document.getElementById("roomInput").value.trim();
        if(!id) return alert("ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        const roomRef = ref(db, `rooms/${id}`);
        const snap = await get(roomRef);
        if(!snap.exists()) return alert("ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        
        myName = prompt("ë‹¹ì‹ ì˜ ì´ë¦„?") || "ë°©ë¬¸ì";
        roomId = id; mySide = "B";

        await update(ref(db, `rooms/${roomId}/players/B`), { name: myName });
        await update(roomRef, { status: "playing", logs: [...snap.val().logs, `${myName} ì…ì¥.`] });
        startGamelistener();
    };

    function startGamelistener() {
        setupUI.style.display = "none";
        gameUI.style.display = "block";
        document.getElementById("roomDisplay").innerText = "ROOM: " + roomId;
        document.getElementById("meDisplay").innerText = myName;
        document.getElementById("mySideDisplay").innerText = mySide === 'A' ? '(í˜¸ìŠ¤íŠ¸)' : '(ê²ŒìŠ¤íŠ¸)';
        
        onValue(ref(db, `rooms/${roomId}`), (snapshot) => {
            const data = snapshot.val();
            if(data) render(data);
        });
    }

    function render(s) {
        document.getElementById("nameA").innerText = s.players.A.name;
        document.getElementById("nameB").innerText = s.players.B.name;
        
        const hpA = s.players.A.hp; const hpB = s.players.B.hp;
        document.getElementById("hpA").style.width = Math.max(0, (hpA / 50 * 100)) + "%";
        document.getElementById("hpB").style.width = Math.max(0, (hpB / 50 * 100)) + "%";
        document.getElementById("hpA").style.background = hpA > 15 ? "#2ecc71" : "#e74c3c";
        document.getElementById("hpB").style.background = hpB > 15 ? "#2ecc71" : "#e74c3c";
        
        document.getElementById("bleedingA").innerText = s.players.A.bleeding ? "ğŸ©¸ì¶œí˜ˆ" : "";
        document.getElementById("bleedingB").innerText = s.players.B.bleeding ? "ğŸ©¸ì¶œí˜ˆ" : "";

        if(s.status === "finished") {
            document.getElementById("turnDisplay").innerText = "ì „íˆ¬ ì¢…ë£Œ";
            document.getElementById("attackBtn").disabled = true;
            document.getElementById("restartBtn").style.display = "block";
            showWinnerCard(s);
        } else {
            const isMyTurn = s.turn === mySide && s.status === "playing";
            document.getElementById("turnDisplay").innerText = isMyTurn ? "ğŸ”´ ë‹¹ì‹ ì˜ í„´ì…ë‹ˆë‹¤!" : "âšª ìƒëŒ€ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤";
            document.getElementById("turnDisplay").style.color = isMyTurn ? "#f1c40f" : "#666";
            document.getElementById("attackBtn").disabled = !isMyTurn || isProcessing;
            document.getElementById("noirCard").style.display = "none";
            document.getElementById("copyBtn").style.display = "none";
        }

        logsEl.innerHTML = "";
        (s.logs || []).forEach(log => {
            const li = document.createElement("li");
            li.innerText = log;
            logsEl.appendChild(li);
        });
        scrollLogs();
    }

    document.getElementById("attackBtn").onclick = async () => {
        if(isProcessing) return;
        isProcessing = true;
        document.getElementById("attackBtn").disabled = true;

        try {
            const roomRef = ref(db, `rooms/${roomId}`);
            const snap = await get(roomRef);
            const s = snap.val();
            
            // í•œ ë²ˆ ë” í„´ í™•ì¸ (ë³´ì•ˆ)
            if(s.turn !== mySide || s.status !== "playing") throw new Error("Not your turn");

            const targetSide = mySide === "A" ? "B" : "A";
            let updates = {};
            let logs = s.logs || [];
            let myHp = s.players[mySide].hp;
            let targetHp = s.players[targetSide].hp;

            if(s.players[mySide].bleeding) {
                myHp -= 2;
                logs.push(`[ìƒíƒœ] ${myName} ì¶œí˜ˆ í”¼í•´ -2`);
            }

            const dice = Math.floor(Math.random() * 20) + 1;
            targetHp -= dice;
            logs.push(`[ê³µê²©] ${myName}: ${dice} í”¼í•´!`);

            if(dice >= 15 && Math.random() < 0.3) {
                updates[`players/${targetSide}/bleeding`] = true;
                logs.push(`[ì¹˜ëª…íƒ€] ${s.players[targetSide].name} ì¶œí˜ˆ ë°œìƒ!`);
            }

            updates[`players/${mySide}/hp`] = myHp;
            updates[`players/${targetSide}/hp`] = targetHp;
            updates[`turn`] = targetSide; // í„´ êµì²´

            if(targetHp <= 0 || myHp <= 0) {
                const winnerSide = targetHp <= 0 ? mySide : targetSide;
                const loserSide = winnerSide === "A" ? "B" : "A";
                updates[`status`] = "finished";
                updates[`winner`] = winnerSide;
                logs.push(`ğŸ† ${s.players[winnerSide].name} ìŠ¹ë¦¬!`);
                logs.push(`ğŸ’¥ ${s.players[loserSide].name} ì „íˆ¬ ë¶ˆëŠ¥.`);
            }
            updates[`logs`] = logs;
            await update(roomRef, updates);
        } catch (e) {
            console.error(e);
        } finally {
            isProcessing = false;
        }
    };

    function showWinnerCard(s) {
        if(s.winner === mySide) {
            const winner = s.players[s.winner];
            const loser = s.players[s.winner === 'A' ? 'B' : 'A'];
            const injuryLog = s.logs.find(l => l.includes("ğŸ’¥")) || "";
            document.getElementById("noirCard").style.display = "block";
            document.getElementById("copyBtn").style.display = "block";
            document.getElementById("noirSummary").innerText = `${winner.name}, ${loser.name} ì œì•• ì™„ë£Œ.`;
            document.getElementById("noirInjury").innerText = injuryLog;
            document.getElementById("noirWinner").innerText = `WINNER: ${winner.name}`;
            document.getElementById("noirDate").innerText = new Date().toLocaleDateString();
        }
    }

    document.getElementById("restartBtn").onclick = () => {
        if(confirm("ì „ì¥ì„ ë‚˜ê°ˆê¹Œìš”? (ë°©ì´ ì´ˆê¸°í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)")) {
            location.reload();
        }
    };

    document.getElementById("copyBtn").onclick = async () => {
        const text = `[BATTLE REPORT]\n${document.getElementById("noirSummary").innerText}\n${document.getElementById("noirInjury").innerText}`;
        try {
            await navigator.clipboard.writeText(text);
            alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) {
            const t = document.createElement("textarea"); t.value = text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
            alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    };
</script>
</body>
</html>
