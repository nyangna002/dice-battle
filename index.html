<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Dice Battle</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  padding: 20px;
  background: #111;
  color: #eee;
  font-family: system-ui, sans-serif;
}
button {
  padding: 10px 14px;
  font-size: 16px;
  margin: 6px 0;
}
button:disabled {
  opacity: 0.4;
}
input {
  padding: 8px;
  font-size: 16px;
}
.hp {
  width: 100%;
  height: 18px;
  background: #333;
  margin-bottom: 10px;
}
.hp > div {
  height: 100%;
  transition: width 0.3s;
}
.log {
  font-size: 14px;
  opacity: 0.9;
}
#restart {
  display: none;
  margin-top: 10px;
  background: #444;
}
</style>
</head>

<body>
<div id="lobby">
  <h2>ğŸ² Dice Battle</h2>
  <button id="create">ë°© ë§Œë“¤ê¸°</button><br><br>
  <input id="code" placeholder="ë°© ì½”ë“œ">
  <button id="join">ì…ì¥</button>
</div>

<div id="room" style="display:none">
  <h3>ë°© ì½”ë“œ: <span id="roomCode"></span></h3>
  <p>ë‚´ í”Œë ˆì´ì–´: <b id="me"></b></p>
  <p>í„´: <b id="turn"></b></p>

  <div>
    <b id="nameA"></b>
    <div class="hp"><div id="hpA"></div></div>
  </div>

  <div>
    <b id="nameB"></b>
    <div class="hp"><div id="hpB"></div></div>
  </div>

  <button id="attack">ğŸ² ê³µê²©</button>
  <button id="restart">ğŸ” ì¬ì‹œì‘</button>

  <ul id="logs"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import {
  getDatabase, ref, get, set, update, onValue
} from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

/* ğŸ”¥ Firebase ì„¤ì • */
const firebaseConfig = {
  apiKey: "AIzaSyB5DBFCeHAy0ZhM3ITwu4MklaGqtqv9vhU",
  authDomain: "dice-7fe9a.firebaseapp.com",
  databaseURL: "https://dice-7fe9a-default-rtdb.firebaseio.com",
  projectId: "dice-7fe9a"
}

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ ë¬¸ì¥ */
const TEXT = {
  attack: (attacker, target, dice) =>
    `âš”ï¸ ${attacker}ì˜ ê³µê²©! (${dice} ë°ë¯¸ì§€)`,
  win: winner =>
    `ğŸ† ì „íˆ¬ ì¢…ë£Œ! ${winner}ì˜ ìŠ¹ë¦¬!`,
  restart: "ğŸ” ì „íˆ¬ê°€ ë‹¤ì‹œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤"
};

/* URL */
const qs = new URLSearchParams(location.search);
const roomId = qs.get("room");

/* localStorage */
let myName = localStorage.getItem("diceName");
let mySide = localStorage.getItem("diceSide");

/* DOM */
const lobby = document.getElementById("lobby");
const room = document.getElementById("room");
const btnCreate = document.getElementById("create");
const btnJoin = document.getElementById("join");
const btnAttack = document.getElementById("attack");
const btnRestart = document.getElementById("restart");

const nameA = document.getElementById("nameA");
const nameB = document.getElementById("nameB");
const hpA = document.getElementById("hpA");
const hpB = document.getElementById("hpB");
const turnEl = document.getElementById("turn");
const meEl = document.getElementById("me");
const logsEl = document.getElementById("logs");

/* ìœ í‹¸ */
function makeCode() {
  return Math.random().toString(36).substring(2, 6).toUpperCase();
}
function hpColor(hp) {
  if (hp > 20) return "#2ecc71";
  if (hp > 10) return "#f1c40f";
  return "#e74c3c";
}

/* ë°© ë§Œë“¤ê¸° */
btnCreate.onclick = async () => {
  myName = prompt("ì´ë¦„ ì…ë ¥");
  if (!myName) return;

  const code = makeCode();
  mySide = "A";

  await set(ref(db, `rooms/${code}`), {
    players: {
      A: { name: myName, hp: 30 },
      B: null
    },
    turn: "A",
    status: "playing",
    logs: []
  });

  localStorage.setItem("diceName", myName);
  localStorage.setItem("diceSide", mySide);
  localStorage.setItem("diceRoom", code);

  location.search = `?room=${code}`;
};

/* ë°© ì…ì¥ */
btnJoin.onclick = async () => {
  const code = document.getElementById("code").value.trim().toUpperCase();
  if (!code) return;

  const snap = await get(ref(db, `rooms/${code}`));
  if (!snap.exists()) {
    alert("ë°©ì´ ì—†ìŠµë‹ˆë‹¤");
    return;
  }

  myName = prompt("ì´ë¦„ ì…ë ¥");
  if (!myName) return;

  const data = snap.val();
  if (data.players.B) {
    alert("ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤");
    return;
  }

  mySide = "B";
  await update(ref(db, `rooms/${code}/players/B`), {
    name: myName,
    hp: 30
  });

  localStorage.setItem("diceName", myName);
  localStorage.setItem("diceSide", mySide);
  localStorage.setItem("diceRoom", code);

  location.search = `?room=${code}`;
};

/* ë°© í™”ë©´ */
if (roomId) {
  lobby.style.display = "none";
  room.style.display = "block";
  document.getElementById("roomCode").innerText = roomId;

  const roomRef = ref(db, `rooms/${roomId}`);

  onValue(roomRef, snap => {
    const s = snap.val();
    if (!s) return;

    meEl.innerText = mySide || "?";
    turnEl.innerText = s.turn;

    nameA.innerText = s.players.A?.name || "ëŒ€ê¸° ì¤‘";
    nameB.innerText = s.players.B?.name || "ëŒ€ê¸° ì¤‘";

    hpA.style.width = (s.players.A.hp / 30 * 100) + "%";
    hpA.style.background = hpColor(s.players.A.hp);
    hpB.style.width = (s.players.B.hp / 30 * 100) + "%";
    hpB.style.background = hpColor(s.players.B.hp);

    btnAttack.disabled =
      s.status !== "playing" ||
      s.turn !== mySide;

    btnRestart.style.display =
      s.status === "finished" ? "block" : "none";

    logsEl.innerHTML = "";
    s.logs.forEach(l => {
      const li = document.createElement("li");
      li.className = "log";
      li.innerText = l;
      logsEl.appendChild(li);
    });
  });

  btnAttack.onclick = async () => {
    const snap = await get(roomRef);
    const s = snap.val();
    if (!s || s.turn !== mySide) return;

    const target = mySide === "A" ? "B" : "A";
    const dice = Math.floor(Math.random() * 20) + 1;
    const newHp = s.players[target].hp - dice;

    let logs = [...s.logs,
      TEXT.attack(myName, s.players[target].name, dice)
    ];

    const updates = {
      [`players/${target}/hp`]: newHp,
      turn: target,
      logs
    };

    if (newHp <= 0) {
      updates.status = "finished";
      updates.logs = [...logs, TEXT.win(myName)];
    }

    await update(roomRef, updates);
  };

  btnRestart.onclick = async () => {
    await update(roomRef, {
      players: {
        A: { name: nameA.innerText, hp: 30 },
        B: { name: nameB.innerText, hp: 30 }
      },
      turn: "A",
      status: "playing",
      logs: [TEXT.restart]
    });
  };
}
</script>
</body>
</html>
